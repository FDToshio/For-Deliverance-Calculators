<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hit/Crit Calculator</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display:flex; gap:12px; align-items:end; flex-wrap:wrap; }
    label { display:block; font-size:12px; opacity:0.8; }
    input { width:90px; padding:6px; font-size:14px; }
    button { padding:8px 12px; font-size:14px; cursor:pointer; }
    #summary { margin: 12px 0; font-weight: 600; white-space: pre-line; }
    #plot { width: 100%; max-width: 980px; height: 520px; }
  </style>
</head>
<body>
  <h2>Exact Hit / Crit Calculator</h2>
  <div class="row">
    <div><label>ATK</label><input id="atk" type="number" value="0"></div>
    <div><label>DEF</label><input id="def" type="number" value="0"></div>
    <button id="run" disabled>Compute</button>
  </div>
  <div id="summary">Loading Python runtime…</div>
  <div id="plot"></div>

<script>
let pyodide;

async function init() {
  pyodide = await loadPyodide();
  document.getElementById("run").disabled = false;
  document.getElementById("summary").textContent = "Ready.";
  await computeAndPlot();
}

async function computeAndPlot() {
  const ATK = parseInt(document.getElementById("atk").value || "0", 10);
  const DEF = parseInt(document.getElementById("def").value || "0", 10);

  const code = `
from collections import Counter
import json

# Final rules (no U):
# A = 2d10 + ATK
# Hit if A >= DEF + 7  <=>  (A - DEF) >= 7
# Crit if A >= 20 (absolute; does NOT depend on DEF)

HIT_T = 7
CRIT_A = 20

dist = Counter()
total = 0

success_freq = 0
crit_freq = 0

# Determine whether crit is even possible given ATK and DEF:
# max A = 20 + ATK - DEF
max_A = 20 + ${ATK} - ${DEF}
has_crit = max_A >= 20

for d10a in range(1, 11):
    for d10b in range(1, 11):
        A = d10a + d10b + ${ATK}
        X = A - ${DEF}
        dist[X] += 1
        total += 1

        if X >= HIT_T:
            success_freq += 1
            if A >= CRIT_A:
                crit_freq += 1

xs = sorted(dist.keys())
ys = [dist[x]/total*100 for x in xs]

payload = {
  "xs": xs,
  "ys": ys,
  "success_freq": success_freq,
  "crit_freq": crit_freq,
  "total": total,
  "HIT_T": HIT_T,
  "CRIT_A": CRIT_A,
  "has_crit": has_crit
}
json.dumps(payload)
  `;

  const payloadJSON = await pyodide.runPythonAsync(code);
  const payload = JSON.parse(payloadJSON);

  const xs = payload.xs;
  const ys = payload.ys;
  const HIT_T = payload.HIT_T;
  const CRIT_A = payload.CRIT_A;
  const hasCrit = !!payload.has_crit;

  // Plotted axis: X = A - DEF. Crit condition A>=20 corresponds to:
  // X >= 20
  const critThresholdOnX = 20;

  // Color per bin on X-axis:
  // fail (<HIT_T), crit (>=critThresholdOnX AND crit possible), else success
  const colors = xs.map(x => {
    if (x < HIT_T) return "red";
    if (hasCrit && x >= critThresholdOnX) return "cyan";
    return "green";
  });

  const successRate = payload.success_freq / payload.total * 100;
  const critRate = payload.crit_freq / payload.total * 100;
  const critOnHit = payload.success_freq > 0 ? (payload.crit_freq / payload.success_freq * 100) : 0;

  const critNote = hasCrit
    ? `Crit condition: A ≥ ${CRIT_A} (equivalently on X: ≥ ${critThresholdOnX})`
    : `Crit condition: A ≥ ${CRIT_A} (IMPOSSIBLE at this ATK)`;

  document.getElementById("summary").textContent =
    `Rules: A = 2d10 + ATK; Hit if A ≥ DEF + 7; Crit if A ≥ 20 (crit ignores DEF)\n` +
    `Success: ${successRate.toFixed(3)}% (${payload.success_freq}/${payload.total})\n` +
    `Crit:    ${critRate.toFixed(3)}% (${payload.crit_freq}/${payload.total})\n` +
    `Crit|Hit:${critOnHit.toFixed(3)}% (${payload.crit_freq}/${payload.success_freq})\n` +
    `Plotted axis: X = A − DEF = 2d10 + ATK − DEF\n` +
    `Hit threshold on X: ≥ ${HIT_T}\n` +
    `${critNote}`;

  const trace = {
    x: xs,
    y: ys,
    type: "bar",
    marker: { color: colors, line: { color: "black", width: 1 } },
    hovertemplate: "X=A−DEF=%{x}<br>%{y:.3f}%<extra></extra>"
  };

  const hitLineX = 7 - 0.5;
  const critLineX = 20 - 0.5;

  // Always include hit line + miss shading; include crit line/shading only if crit possible
  const shapes = [
    // Hit threshold line
    {
      type: "line",
      x0: hitLineX, x1: hitLineX,
      y0: 0, y1: 1, xref: "x", yref: "paper",
      line: { color: "black", width: 2, dash: "dash" }
    },
    // Miss region shade (X < HIT_T)
    {
      type: "rect",
      x0: xs[0] - 0.5, x1: hitLineX,
      y0: 0, y1: 1, xref: "x", yref: "paper",
      fillcolor: "rgba(255,0,0,0.15)",
      line: { width: 0 }
    }
  ];

  if (hasCrit) {
    shapes.push(
      // Crit threshold line on X-axis (corresponding to A>=20)
      {
        type: "line",
        x0: critLineX, x1: critLineX,
        y0: 0, y1: 1, xref: "x", yref: "paper",
        line: { color: "black", width: 2, dash: "dash" }
      },
      // Crit region shade (A>=20 => X >= 20-DEF)
      {
        type: "rect",
        x0: critLineX, x1: xs[xs.length - 1] + 0.5,
        y0: 0, y1: 1, xref: "x", yref: "paper",
        fillcolor: "rgba(0,255,255,0.15)",
        line: { width: 0 }
      }
    );
  }

  const layout = {
    title: `Exact Distribution: X = 2d10 + ATK(${ATK}) - DEF(${DEF})`,
    xaxis: { title: "X = A − DEF", dtick: 1 },
    yaxis: { title: "Frequency (%)", rangemode: "tozero" },
    shapes: shapes,
    margin: { t: 60, r: 20, b: 60, l: 60 }
  };

  Plotly.newPlot("plot", [trace], layout, { displayModeBar: false });
}

document.getElementById("run").addEventListener("click", computeAndPlot);
init();
</script>
</body>
</html>
