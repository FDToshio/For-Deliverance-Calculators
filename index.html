<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hit/Crit Calculator</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display:flex; gap:12px; align-items:end; flex-wrap:wrap; }
    label { display:block; font-size:12px; opacity:0.8; }
    input { width:90px; padding:6px; font-size:14px; }
    button { padding:8px 12px; font-size:14px; cursor:pointer; }
    #summary { margin: 12px 0; font-weight: 600; white-space: pre-line; }
    #plot { width: 100%; max-width: 980px; height: 520px; }
  </style>
</head>
<body>
  <h2>Exact Hit / Crit Calculator</h2>
  <div class="row">
    <div><label>ATK</label><input id="atk" type="number" value="0"></div>
    <div><label>DEF</label><input id="def" type="number" value="0"></div>
    <button id="run" disabled>Compute</button>
  </div>
  <div id="summary">Loading Python runtime…</div>
  <div id="plot"></div>

<script>
let pyodide;

async function init() {
  pyodide = await loadPyodide();
  document.getElementById("run").disabled = false;
  document.getElementById("summary").textContent = "Ready.";
  await computeAndPlot();
}

async function computeAndPlot() {
  const ATK = parseInt(document.getElementById("atk").value || "0", 10);
  const DEF = parseInt(document.getElementById("def").value || "0", 10);

  const code = `
from collections import Counter
import json

# New rules (no U):
# A = 2d10 + ATK
# Miss if A < DEF + 7
# Hit  if A >= DEF + 7
# Crit if A >= 20  (absolute threshold)

T = 7
CRIT_T = 20

def exact_dist_2d10():
    c = Counter()
    total = 0
    for d10a in range(1, 11):
        for d10b in range(1, 11):
            c[d10a + d10b] += 1
            total += 1
    return c, total

def shifted_dist(ATK, DEF):
    base, total = exact_dist_2d10()
    shift = ATK - DEF
    out = Counter()
    for v, f in base.items():
        out[v + shift] += f
    return out, total

dist, total = shifted_dist(${ATK}, ${DEF})
xs = sorted(dist.keys())
ys = [dist[x]/total*100 for x in xs]

# Hit if A >= DEF + 7  -> (2d10 + ATK - DEF) >= 7
success_freq = sum(f for x,f in dist.items() if x >= T)

# Crit if A >= 20 -> (2d10 + ATK - DEF) >= (20)
# Since dist is already shifted by (ATK - DEF), the crit threshold depends on DEF:
crit_threshold_shifted = CRIT_T - ${DEF}
crit_freq = sum(f for x,f in dist.items() if x >= crit_threshold_shifted)

payload = {
  "xs": xs,
  "ys": ys,
  "success_freq": success_freq,
  "crit_freq": crit_freq,
  "total": total,
  "T": T,
  "CRIT_T": CRIT_T,
  "crit_threshold_shifted": crit_threshold_shifted
}
json.dumps(payload)
  `;

  const payloadJSON = await pyodide.runPythonAsync(code);
  const payload = JSON.parse(payloadJSON);

  const xs = payload.xs;
  const ys = payload.ys;
  const T = payload.T;
  const CRIT_T = payload.CRIT_T;
  const critThresholdShifted = payload.crit_threshold_shifted;

  // Color per bin:
  // fail (<T), crit (>=critThresholdShifted), else success
  const colors = xs.map(x =>
    (x < T) ? "red" :
    (x >= critThresholdShifted) ? "cyan" :
    "green"
  );

  const successRate = payload.success_freq / payload.total * 100;
  const critRate = payload.crit_freq / payload.total * 100;
  const critOnHit = payload.success_freq > 0 ? (payload.crit_freq / payload.success_freq * 100) : 0;

  document.getElementById("summary").textContent =
    `Rules: A = 2d10 + ATK; Hit if A ≥ DEF + 7; Crit if A ≥ 20\n` +
    `Success: ${successRate.toFixed(3)}% (${payload.success_freq}/${payload.total})\n` +
    `Crit:    ${critRate.toFixed(3)}% (${payload.crit_freq}/${payload.total})\n` +
    `Crit|Hit:${critOnHit.toFixed(3)}% (${payload.crit_freq}/${payload.success_freq})\n` +
    `Hit threshold (shifted): ≥ ${T}\n` +
    `Crit threshold (absolute): A ≥ ${CRIT_T}  (shifted threshold: ≥ ${critThresholdShifted})`;

  const trace = {
    x: xs,
    y: ys,
    type: "bar",
    marker: { color: colors, line: { color: "black", width: 1 } },
    hovertemplate: "A-DEF Roll=%{x}<br>%{y:.3f}%<extra></extra>"
  };

  // Vertical lines should be drawn at boundaries between integers:
  const hitLineX = T - 0.5;
  const critLineX = critThresholdShifted - 0.5;

  const layout = {
    title: `Exact Distribution: 2d10 + ATK(${ATK}) - DEF(${DEF})`,
    xaxis: { title: "A − DEF (i.e., 2d10 + ATK − DEF)", dtick: 1 },
    yaxis: { title: "Frequency (%)", rangemode: "tozero" },
    shapes: [
      // Hit threshold line
      { type:"line", x0:hitLineX, x1:hitLineX, y0:0, y1:1, xref:"x", yref:"paper",
        line:{color:"black", width:2, dash:"dash"} },

      // Crit threshold line
      { type:"line", x0:critLineX, x1:critLineX, y0:0, y1:1, xref:"x", yref:"paper",
        line:{color:"black", width:2, dash:"dash"} },

      // Failure shade (x < T)
      { type:"rect", x0:xs[0]-0.5, x1:hitLineX, y0:0, y1:1, xref:"x", yref:"paper",
        fillcolor:"rgba(255,0,0,0.15)", line:{width:0} },

      // Crit shade (x >= critThresholdShifted)
      { type:"rect", x0:critLineX, x1:xs[xs.length-1]+0.5, y0:0, y1:1, xref:"x", yref:"paper",
        fillcolor:"rgba(0,255,255,0.15)", line:{width:0} }
    ],
    margin: { t: 60, r: 20, b: 60, l: 60 }
  };

  Plotly.newPlot("plot", [trace], layout, {displayModeBar: false});
}

document.getElementById("run").addEventListener("click", computeAndPlot);
init();
</script>
</body>
</html>
